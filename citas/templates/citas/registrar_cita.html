{% extends 'layouts/base.html' %}

{% block title %} Registrar Cita {% endblock title %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-xl-12 order-xl-1">
      <div class="card">
        <div class="card-header">
          <h3 class="mb-0">Registrar Cita</h3>
        </div>
        <div class="card-body">

          <!-- FORMULARIO GET (filtros) -->
          <form method="get" class="mb-4">

            <!-- Especialidad -->
            <div class="form-group mb-3">
              <label>Especialidad</label>
              <select name="especialidad" class="form-control" onchange="this.form.submit()">
                <option value="">-- Seleccione especialidad --</option>
                {% for esp in especialidades %}
                <option value="{{ esp.id }}" {% if esp.id == selected_esp %} selected{% endif %}>
                  {{ esp.nombre }}
                </option>
                {% endfor %}
              </select>
            </div>

            <!-- Doctor -->
            <div class="form-group mb-3">
              <label>Doctor</label>
              <select name="doctor" class="form-control" {% if not doctores %}disabled{% endif %} onchange="this.form.submit()">
                <option value="">-- Seleccione doctor --</option>
                {% for doc in doctores %}
                <option value="{{ doc.id }}" {% if doc.id == selected_doc %} selected{% endif %}>
                  Dr. {{ doc.entidad.nombre }} {{ doc.entidad.apellidoPaterno }} {{ doc.entidad.apellidoMaterno }}
                  ({{ doc.especialidad.nombre }})
                </option>
                {% endfor %}
              </select>
            </div>

          </form>

          <!-- INFO DOCTOR SELECCIONADO -->
          {% if selected_doc %}
          <div class="alert alert-info">
            {% for doc in doctores %}
            {% if doc.id == selected_doc %}
            <strong>Doctor seleccionado:</strong>
            Dr. {{ doc.entidad.nombre }} {{ doc.entidad.apellidoPaterno }} {{ doc.entidad.apellidoMaterno }}
            – {{ doc.especialidad.nombre }}
            {% endif %}
            {% endfor %}
          </div>
          {% else %}
          <div class="alert alert-warning">
            Selecciona una especialidad y un doctor antes de registrar la cita.
          </div>
          {% endif %}

          <!-- FORMULARIO POST (cita) -->
          <form method="post">
            {% csrf_token %}

            {% if selected_doc %}
            <input type="hidden" name="doctor_id" value="{{ selected_doc }}">
            {% endif %}

            <!-- DNI del paciente -->
            <div class="form-group mb-3">
              <label>DNI del Paciente</label>
              <input type="text" name="dni" class="form-control" required>
              {% if errors.dni %}
              <small class="text-danger">{{ errors.dni }}</small>
              {% endif %}
            </div>

            <!-- Clasificación -->
            <div class="form-group mb-3">
              <label>Clasificación</label>
              <select name="clasificacion" class="form-control" required>
                <option value="EMERGENCIA">Emergencia</option>
                <option value="ADULTO_MAYOR">Adulto mayor</option>
                <option value="REGULAR" selected>Regular</option>
              </select>
              {% if errors.clasificacion %}
              <small class="text-danger">{{ errors.clasificacion }}</small>
              {% endif %}
            </div>

            <!-- Tipo de cita-->
            <div class="form-group mb-3">
              <label>Tipo de cita</label>
              <select name="tipo_cita" class="form-control" required>
                <option value="PRESENCIAL" selected>Presencial</option>
                <option value="VIRTUAL">Virtual</option>
              </select>
              {% if errors.tipo_cita %}
              <small class="text-danger">{{ errors.tipo_cita }}</small>
              {% endif %}
            </div>

            <!-- Motivo -->
            <div class="form-group mb-3">
              <label>Motivo</label>
              <textarea name="motivo" class="form-control" rows="3" required></textarea>
              {% if errors.motivo %}
              <small class="text-danger">{{ errors.motivo }}</small>
              {% endif %}
            </div>

            <!-- Botones -->
            <button type="submit" class="btn btn-primary" {% if not selected_doc %}disabled{% endif %}>
              Registrar Cita
            </button>
            <a href="{% url 'lista_citas_paciente' request.session.entidad_id %}" class="btn btn-secondary">
              Cancelar
            </a>

          </form>

        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}
