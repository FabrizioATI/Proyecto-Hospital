{% extends 'layouts/base.html' %}

{% block title %} Registro de Horario de Doctor {% endblock title %}

{% block content %}

<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-xl-12 order-xl-1">
      <div class="card">
        <div class="card-header">
          <div class="row align-items-center">
            <div class="col-8">
              <h3 class="mb-0">Registrar Horario de Doctor</h3>
            </div>
          </div>
        </div>
        <div class="card-body">
          <form method="post">
            {% csrf_token %}

            <!-- Seleccionar Doctor -->
            <h6 class="heading-small text-muted mb-4">Doctor</h6>
            <div class="pl-lg-4">
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                    <label class="form-control-label">Seleccione Doctor</label>
                    <select name="doctor" class="form-control">
                      {% for doc in doctores %}
                        <option value="{{ doc.id }}">
                          Dr. {{ doc.entidad.nombre }} {{ doc.entidad.apellidoPaterno }} - {{ doc.especialidad.nombre }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <hr class="my-4" />

            <!-- Datos de Horario -->
            <h6 class="heading-small text-muted mb-4">Datos del Horario</h6>
            <div class="pl-lg-4">
              <div class="row">
                <div class="col-lg-4">
                  <div class="form-group">
                    <label class="form-control-label">Fecha</label>
                    <input type="date" name="fecha" class="form-control" required>
                  </div>
                </div>
                <div class="col-lg-4">
                  <div class="form-group">
                    <label class="form-control-label">Hora Inicio</label>
                    <input type="time" name="hora_inicio" class="form-control" required>
                  </div>
                </div>
                <div class="col-lg-4">
                  <div class="form-group">
                    <label class="form-control-label">Hora Fin</label>
                    <input type="time" name="hora_fin" class="form-control" required>
                  </div>
                </div>
              </div>
            </div>

            <div class="text-right">
              <button type="submit" class="btn btn-primary">Guardar</button>

            </div>

          </form>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block javascripts %}
<style>
  /* Estilo que añadi para el colorcito del campo */
  input.holiday {
    background: #ffefef;
    border-color: #d33;
    color: #900;
  }
  .holiday-msg {
    color: #900;
    font-size: .9rem;
    margin-top: .25rem;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const input = document.querySelector('input[name="fecha"]');
  if(!input) return;
  const form = input.closest('form');

  // Se usa la URL nombrada para ser robustos a cambios de prefijo
  const holidaysUrl = "{% url 'holidays_json' %}";

  fetch(holidaysUrl)
    .then(r => r.ok ? r.json() : [])
    .then(holidays => {
      function checkDate(){
        const val = input.value; // YYYY-MM-DD
        const isHoliday = holidays.indexOf(val) !== -1;
        if(isHoliday){
          input.classList.add('holiday');
          input.setCustomValidity('La fecha seleccionada es un feriado y no está disponible.');
        } else {
          input.classList.remove('holiday');
          input.setCustomValidity('');
        }

        // Mensaje que semuestra debajo del calendario
        let msg = input.parentNode.querySelector('.holiday-msg');
        if(isHoliday && !msg){
          msg = document.createElement('div');
          msg.className = 'holiday-msg';
          msg.textContent = 'Fecha feriado — no disponible.';
          input.parentNode.appendChild(msg);
        } else if(!isHoliday && msg){
          msg.remove();
        }
      }

      input.addEventListener('change', checkDate);
      if(input.value) checkDate();

      if(form){
        form.addEventListener('submit', function(e){
          if(!input.checkValidity()){
            e.preventDefault();
            input.reportValidity();
          }
        });
      }
    })
    .catch(()=>{ /* si falla la carga de feriados, no bloquear */ });
});
</script>

{% endblock javascripts %}
